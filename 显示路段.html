<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
		#l-map{height:80%;width:100%;}
		#r-result {width:100%;}
	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=inGwP7mGu57t6fPT0OVmBY35"></script>
	<title>公交/地铁线路查询</title>
</head>
<body>
	<div id="l-map"></div>
</body>
</html>
<script type="text/javascript">
	// 百度地图API功能
	var map = new BMap.Map("l-map");            // 创建Map实例
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);
	var myStyleJson=[
		{
					"featureType": "water",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "green",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "manmade",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "building",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
				{
					"featureType": "poi",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "administrative",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "subway",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "railway",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
},
{
					"featureType": "highway",
					"elementType": "all",
					"stylers": {
										"color": "#ead1dc",
										"visibility": "on"
					}
},
{
					"featureType": "arterial",
					"elementType": "all",
					"stylers": {
										"visibility": "off"
					}
}

	]
   map.setMapStyle({styleJson: myStyleJson });

	function dis2(left,right){
		return (left.lng - right.lng)*(left.lng - right.lng) + (left.lat - right.lat)*(left.lat - right.lat);
	}
	//findx point on AB nearest to x

	function getNearest(A,B,x){
		var cur = 0.0000001;
		var left = {lng:A.lng,lat:A.lat};
		var right = {lng:B.lng,lat:B.lat};
		while(dis2(left,right)>cur){
			var middle = {lng:(left.lng+right.lng)/2,lat:(left.lat+right.lat)/2};
			var disleft = dis2(left,x);
			var disright = dis2(right,x);
			if(disleft<disright){
				right.lng = middle.lng;
				right.lat = middle.lat;
			}else{
				left.lng = middle.lng;
				left.lat = middle.lat;
			}
		}
		left.dis2 = dis2(left,x);
		return left;
	}
	//找到离x最近的点所在的段,以及该点
	function getMinSeg(path,x){
		var res = {lng:0,lat:0};
		var mindis2 = 1000000000;
		for(var i = 0;i+1<path.length;i++){
			var nearest = getNearest(path[i],path[i+1],x);
			if(nearest.dis2<mindis2){
				mindis2 = nearest.dis2;
				res.lng = nearest.lng;
				res.lat = nearest.lat;
				res.ai = i;
				res.bi = i+1;
			}
		}
		return res;
	}
	//找到AB之间的点
	function getSubPath(path,A,B){
		var mA = getMinSeg(path,A);
		var mB = getMinSeg(path,B);
		var res = [];
		res.push(mA);
		for(var i = mA.bi;i<=mB.ai;i++){
			res.push(path[i]);
		}
		res.push(mB);
		return res;
	}
	var busline = new BMap.BusLineSearch(map,{
		onGetBusListComplete: function(result){
		   if(result) {
			 var fstLine = result.getBusListItem(0);//获取第一个公交列表显示到map上
			 busline.getBusLine(fstLine);
		   }
		},
		onGetBusLineComplete:function(result){
        		var path = result.getPath();
						var A = result.getBusStation(0).position;
						var B = result.getBusStation(8).position;
						var subPath = getSubPath(path,A,B);
						var polyline = new BMap.Polyline(subPath);
						map.addOverlay(polyline);
						map.setViewport(subPath); // 自动适应屏幕大小
		}
	});
	function busSearch(){
		var busName = 331;
		busline.getBusList(busName);
	}
	setTimeout(function(){
		busSearch();
	},1500);
</script>
